<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>–î–æ–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å (AR). –ú–∞–≥–∏—è –í–µ—Ä—Ç–µ–∫—Å –ê–†–¢.</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.2/aframe/build/aframe-ar-nft.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        #start-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 100;
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        #start-btn:hover {
            background-color: #45a049;
        }
        #start-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 99;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .arjs-loader div {
            text-align: center;
            font-size: 1.25em;
            color: white;
        }
        .status-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 100;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 4px;
            font-size: 14px;
        }
        .archived-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        .archived-overlay h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .archived-overlay p {
            font-size: 1.2em;
            margin-bottom: 30px;
            max-width: 600px;
            line-height: 1.6;
        }
        .archived-overlay .icon {
            font-size: 5em;
            margin-bottom: 30px;
            opacity: 0.9;
        }
        @media (max-width: 768px) {
            .archived-overlay h1 {
                font-size: 1.8em;
            }
            .archived-overlay p {
                font-size: 1em;
            }
            .archived-overlay .icon {
                font-size: 3.5em;
            }
        }
    </style>
</head>
<body>
    {% if record.status == 'archived' %}
    <!-- Archived state overlay -->
    <div class="archived-overlay">
        <div class="icon">üì¶</div>
        <h1>–ê–∫—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞</h1>
        <p>–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –¥–∞–Ω–Ω–∞—è –∞–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.</p>
    </div>
    {% else %}
    <!-- –ö–Ω–æ–ø–∫–∞ —Å—Ç–∞—Ä—Ç, –Ω—É–∂–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ -->
    <button id="start-btn" onclick="startVideo()" disabled>–ó–∞–ø—É—Å—Ç–∏—Ç—å –≤–∏–¥–µ–æ</button>
    <div class="status-indicator" id="status-indicator">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    
    <!-- Loading indicator -->
    <div class="arjs-loader" id="loader">
        <div>
            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–ø–æ–ª–Ω–µ–Ω–Ω–æ–π —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ (AR)</div>
            <div>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ</div>
            <div class="loading-spinner">‚óè‚óè‚óè</div>
        </div>
    </div>

    <!-- AR Scene -->
    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true;"
        id="ar-scene"
    >
        <!-- NFT Marker Entity -->
        <a-nft
            type="nft"
            url="{{ request.url.scheme }}://{{ request.url.netloc }}/nft-markers/{{ record.id }}"
            smooth="true"
            smoothCount="10"
            smoothTolerance="0.01"
            smoothThreshold="5"
            id="nft-marker"
        >
            <!-- Video Entity -->
            <a-video
                id="ar-video"
                src="{{ record.video_url }}"
                width="1.5"
                height="1"
                position="0 0 0"
                rotation="-90 0"
                scale="1 1 1"
                autoplay="false"
                webkit-playsinline
                playsinline
                muted
                loop="false"
            ></a-video>
        </a-nft>

        <!-- Camera Entity -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞
        let isVideoPlaying = false;
        let isMarkerDetected = false;
        let videoTimeout = null;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞
        function updateStatus(message) {
            const statusEl = document.getElementById('status-indicator');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ –≤–∏–¥–µ–æ
        function startVideo() {
            const video = document.getElementById('ar-video');
            if (!video) return;
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —Ç–∞–π–º–µ—Ä, –µ—Å–ª–∏ –æ–Ω –±—ã–ª
            if (videoTimeout) {
                clearTimeout(videoTimeout);
            }
            
            // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –≤–∏–¥–µ–æ
            video.play()
                .then(() => {
                    isVideoPlaying = true;
                    updateStatus('–í–∏–¥–µ–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è...');
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 5 —Å–µ–∫—É–Ω–¥
                    videoTimeout = setTimeout(() => {
                        pauseVideo();
                        updateStatus('–í–∏–¥–µ–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ (5 —Å–µ–∫)');
                    }, 5000);
                })
                .catch(e => {
                    console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Å—Ç–∞—Ä—Ç–∞ –≤–∏–¥–µ–æ: ", e);
                    updateStatus('–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è');
                });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –ø–∞—É–∑—ã –≤–∏–¥–µ–æ
        function pauseVideo() {
            const video = document.getElementById('ar-video');
            if (video) {
                video.pause();
                video.currentTime = 0;
                isVideoPlaying = false;
            }
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ü–µ–Ω—ã
        document.querySelector('a-scene').addEventListener('loaded', function() {
            // –°–∫—Ä—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.display = 'none';
            }
            
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–ø—É—Å–∫–∞
            const startBtn = document.getElementById('start-btn');
            if (startBtn) {
                startBtn.disabled = false;
            }
            
            updateStatus('–°—Ü–µ–Ω–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–∞
        document.querySelector('a-scene').addEventListener('markerFound', function() {
            isMarkerDetected = true;
            updateStatus('–ú–∞—Ä–∫–µ—Ä –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
            
            // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∫–Ω–æ–ø–∫–∞ —É–∂–µ –¥–æ—Å—Ç—É–ø–Ω–∞
            // –ù–∞ –¥–µ—Å–∫—Ç–æ–ø–µ –º–æ–∂–µ–º –∞–≤—Ç–æ—Å—Ç–∞—Ä—Ç–æ–≤–∞—Ç—å
            if (!/Android|iPhone|iPad/i.test(navigator.userAgent)) {
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
                setTimeout(() => {
                    if (!isVideoPlaying) {
                        startVideo();
                    }
                }, 500);
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏—è –ø–æ—Ç–µ—Ä–∏ –º–∞—Ä–∫–µ—Ä–∞
        document.querySelector('a-scene').addEventListener('markerLost', function() {
            isMarkerDetected = false;
            
            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ –º–∞—Ä–∫–µ—Ä–∞
            if (isVideoPlaying) {
                pauseVideo();
                updateStatus('–ú–∞—Ä–∫–µ—Ä –ø–æ—Ç–µ—Ä—è–Ω');
                
                // –û—á–∏—â–∞–µ–º —Ç–∞–π–º–µ—Ä
                if (videoTimeout) {
                    clearTimeout(videoTimeout);
                    videoTimeout = null;
                }
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –≤–∏–¥–µ–æ
        document.getElementById('ar-video').addEventListener('error', function(e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ –¥–ª—è AR-–æ–ø—ã—Ç–∞:', e);
            updateStatus('–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ');
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ
        document.getElementById('ar-video').addEventListener('ended', function() {
            isVideoPlaying = false;
            updateStatus('–í–∏–¥–µ–æ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
        });
        
        // –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–∞—Ö (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ)
        window.onload = function() {
            if (!/Android|iPhone|iPad/i.test(navigator.userAgent)) {
                // –ö–Ω–æ–ø–∫–∞ –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ü–µ–Ω—ã
                updateStatus('–û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏...');
            } else {
                updateStatus('–û–∂–∏–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞...');
            }
        };
    </script>
    {% endif %}
    
    <!-- Footer -->
    <footer style="position: fixed; bottom: 0; left: 0; right: 0; background-color: rgba(0, 0, 0, 0.8); color: white; text-align: center; padding: 10px; font-size: 12px; z-index: 1000;">
        <p>&copy; 2025 Vertex AR. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã. | –î–æ–ø–æ–ª–Ω–µ–Ω–Ω–∞—è —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞</p>
    </footer>
</body>
</html>
