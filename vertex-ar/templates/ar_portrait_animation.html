<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>Vertex AR Portrait Animation</title>
    <!-- A-Frame и AR.js библиотеки -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.2/aframe/build/aframe-ar-nft.js"></script>
    <!-- Anime.js для анимаций -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            background-color: #000;
        }

        #start-btn {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 100;
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            display: none;
        }

        #start-btn:hover {
            background-color: #45a049;
        }

        #start-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 99;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .arjs-loader div {
            text-align: center;
            font-size: 1.25em;
            color: white;
        }

        .status-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 100;
            padding: 8px 12px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 4px;
            font-size: 14px;
        }

        .animation-controls {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            gap: 10px;
        }

        .animation-btn {
            padding: 8px 12px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .animation-btn:hover {
            background-color: #0b7dda;
        }

        .animation-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Кнопка запуска видео, необходима для мобильных браузеров -->
    <button id="start-btn" onclick="startAnimation()" disabled>Запустить анимацию</button>

    <!-- Индикатор статуса -->
    <div class="status-indicator" id="status-indicator">Загрузка AR-опыта...</div>

    <!-- Кнопки управления анимацией -->
    <div class="animation-controls" id="animation-controls" style="display: none;">
        <button class="animation-btn" onclick="triggerBlinkAnimation()">Моргание</button>
        <button class="animation-btn" onclick="triggerHeadTurn()">Поворот головы</button>
        <button class="animation-btn" onclick="triggerSmile()">Улыбка</button>
        <button class="animation-btn" onclick="triggerWink()">Подмигивание</button>
    </div>

    <!-- Индикатор загрузки -->
    <div class="arjs-loader" id="loader">
        <div>
            <div>Загрузка AR-опыта</div>
            <div>Пожалуйста, подождите</div>
            <div class="loading-spinner">●●●</div>
        </div>
    </div>

    <!-- AR Сцена -->
    <a-scene
        vr-mode-ui="enabled: false"
        embedded
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true;"
        id="ar-scene"
    >
        <!-- NFT Маркер для обнаружения изображения -->
        <a-nft
            type="nft"
            url="{{ request.url.scheme }}://{{ request.url.netloc }}/nft-markers/{{ portrait_id }}"
            smooth="true"
            smoothCount="10"
            smoothTolerance="0.01"
            smoothThreshold="5"
            id="nft-marker"
        >
            <!-- 3D модель портрета -->
            <a-entity
                id="portrait-entity"
                position="0 0 0"
                scale="1 1 1"
                rotation="0 0 0"
            >
                <!-- Основной элемент портрета -->
                <a-image
                    id="portrait-base"
                    src="{{ portrait_image_url }}"
                    width="1.5"
                    height="2"
                    position="0 0 0"
                    material="shader: flat; transparent: true;"
                ></a-image>

                <!-- Элементы для анимации (глаза, рот и т.д.) -->
                <a-entity id="eyes-container" position="0 0.2 0.01">
                    <a-entity id="left-eye" position="-0.2 0 0">
                        <a-box id="left-eye-blink" position="0 0 0" width="0.1" height="0.05" depth="0.01" color="black" visible="false"></a-box>
                    </a-entity>
                    <a-entity id="right-eye" position="0.2 0 0">
                        <a-box id="right-eye-blink" position="0 0 0" width="0.1" height="0.05" depth="0.01" color="black" visible="false"></a-box>
                    </a-entity>
                </a-entity>

                <a-entity id="mouth-container" position="0 -0.3 0.01">
                    <a-box id="mouth" position="0 0 0" width="0.3" height="0.1" depth="0.01" color="pink" visible="false"></a-box>
                </a-entity>
            </a-entity>
        </a-nft>

        <!-- Камера -->
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        // Состояния для отслеживания процесса
        let isAnimationPlaying = false;
        let isMarkerDetected = false;
        let currentAnimation = null;

        // Обновляем индикатор статуса
        function updateStatus(message) {
            const statusEl = document.getElementById('status-indicator');
            if (statusEl) {
                statusEl.textContent = message;
            }
        }

        // Инициализация анимаций при загрузке сцены
        function initAnimations() {
            // Анимация моргания
            window.blinkAnimation = anime({
                targets: ['#left-eye-blink', '#right-eye-blink'],
                height: [
                    { value: '0.05', duration: 50, easing: 'linear' },
                    { value: '0.01', duration: 50, easing: 'linear' },
                    { value: '0.05', duration: 50, easing: 'linear' }
                ],
                opacity: [
                    { value: 1, duration: 50, easing: 'linear' },
                    { value: 0, duration: 10, easing: 'linear' }
                ],
                autoplay: false,
                duration: 200
            });

            // Анимация улыбки
            window.smileAnimation = anime({
                targets: '#mouth',
                height: [
                    { value: 0.1, duration: 200, easing: 'easeInOutQuad' },
                    { value: 0.15, duration: 300, easing: 'easeInOutQuad' },
                    { value: 0.1, duration: 200, easing: 'easeInOutQuad' }
                ],
                width: [
                    { value: 0.3, duration: 200, easing: 'easeInOutQuad' },
                    { value: 0.4, duration: 300, easing: 'easeInOutQuad' },
                    { value: 0.3, duration: 200, easing: 'easeInOutQuad' }
                ],
                autoplay: false,
                duration: 700
            });

            // Анимация поворота головы
            window.headTurnAnimation = anime({
                targets: '#portrait-entity',
                rotation: [
                    { y: 0, duration: 300, easing: 'easeInOutQuad' },
                    { y: 15, duration: 400, easing: 'easeInOutQuad' },
                    { y: -15, duration: 800, easing: 'easeInOutQuad' },
                    { y: 0, duration: 400, easing: 'easeInOutQuad' }
                ],
                autoplay: false,
                duration: 1900
            });

            // Анимация подмигивания
            window.winkAnimation = anime({
                targets: '#right-eye-blink',
                height: [
                    { value: '0.05', duration: 50, easing: 'linear' },
                    { value: '0.01', duration: 100, easing: 'linear' },
                    { value: '0.05', duration: 50, easing: 'linear' }
                ],
                opacity: [
                    { value: 1, duration: 50, easing: 'linear' },
                    { value: 0, duration: 150, easing: 'linear' }
                ],
                autoplay: false,
                duration: 300
            });
        }

        // Функция запуска анимации
        function startAnimation() {
            if (!isMarkerDetected) return;

            // Показываем элементы анимации
            document.getElementById('left-eye-blink').setAttribute('visible', 'true');
            document.getElementById('right-eye-blink').setAttribute('visible', 'true');
            document.getElementById('mouth').setAttribute('visible', 'true');

            // Запускаем случайную анимацию
            const animations = [window.blinkAnimation, window.smileAnimation, window.headTurnAnimation];
            const randomAnimation = animations[Math.floor(Math.random() * animations.length)];

            if (currentAnimation) {
                currentAnimation.pause();
            }

            currentAnimation = randomAnimation;
            currentAnimation.restart();

            isAnimationPlaying = true;
            updateStatus('Анимация запущена');
        }

        // Триггер анимации моргания
        function triggerBlinkAnimation() {
            if (!isMarkerDetected) return;

            document.getElementById('left-eye-blink').setAttribute('visible', 'true');
            document.getElementById('right-eye-blink').setAttribute('visible', 'true');

            if (currentAnimation) {
                currentAnimation.pause();
            }

            currentAnimation = window.blinkAnimation;
            currentAnimation.restart();

            updateStatus('Анимация моргания');
        }

        // Триггер анимации поворота головы
        function triggerHeadTurn() {
            if (!isMarkerDetected) return;

            if (currentAnimation) {
                currentAnimation.pause();
            }

            currentAnimation = window.headTurnAnimation;
            currentAnimation.restart();

            updateStatus('Анимация поворота головы');
        }

        // Триггер анимации улыбки
        function triggerSmile() {
            if (!isMarkerDetected) return;

            document.getElementById('mouth').setAttribute('visible', 'true');

            if (currentAnimation) {
                currentAnimation.pause();
            }

            currentAnimation = window.smileAnimation;
            currentAnimation.restart();

            updateStatus('Анимация улыбки');
        }

        // Триггер анимации подмигивания
        function triggerWink() {
            if (!isMarkerDetected) return;

            document.getElementById('right-eye-blink').setAttribute('visible', 'true');

            if (currentAnimation) {
                currentAnimation.pause();
            }

            currentAnimation = window.winkAnimation;
            currentAnimation.restart();

            updateStatus('Анимация подмигивания');
        }

        // Обработка события загрузки сцены
        document.querySelector('a-scene').addEventListener('loaded', function() {
            // Инициализируем анимации
            initAnimations();

            // Скрываем лоадер
            const loader = document.getElementById('loader');
            if (loader) {
                loader.style.display = 'none';
            }

            // Активируем кнопку запуска
            const startBtn = document.getElementById('start-btn');
            if (startBtn) {
                startBtn.style.display = 'block';
                startBtn.disabled = false;
            }

            updateStatus('Сцена загружена, ожидание маркера...');
        });

        // Обработка события обнаружения маркера
        document.querySelector('a-scene').addEventListener('markerFound', function() {
            isMarkerDetected = true;
            updateStatus('Маркер обнаружен! Активируйте анимацию');

            // Показываем кнопки управления анимацией
            const controls = document.getElementById('animation-controls');
            if (controls) {
                controls.style.display = 'flex';
            }

            // На десктопе можем автостартовать ненавязчивую анимацию
            if (!/Android|iPhone|iPad/i.test(navigator.userAgent)) {
                // Небольшая задержка для стабильности
                setTimeout(() => {
                    // Автоматически запускаем моргание каждые 3-5 секунд
                    setInterval(() => {
                        if (isMarkerDetected && !isAnimationPlaying) {
                            triggerBlinkAnimation();
                        }
                    }, 3000 + Math.random() * 2000);
                }, 500);
            }
        });

        // Обработка события потери маркера
        document.querySelector('a-scene').addEventListener('markerLost', function() {
            isMarkerDetected = false;

            // Останавливаем текущую анимацию
            if (currentAnimation) {
                currentAnimation.pause();
                currentAnimation = null;
            }

            isAnimationPlaying = false;
            updateStatus('Маркер потерян');

            // Скрываем кнопки управления анимацией
            const controls = document.getElementById('animation-controls');
            if (controls) {
                controls.style.display = 'none';
            }

            // Скрываем элементы анимации
            document.getElementById('left-eye-blink').setAttribute('visible', 'false');
            document.getElementById('right-eye-blink').setAttribute('visible', 'false');
            document.getElementById('mouth').setAttribute('visible', 'false');
        });

        // Обработка окончания анимации
        if (window.blinkAnimation) {
            window.blinkAnimation.finished.then(() => {
                isAnimationPlaying = false;
                document.getElementById('left-eye-blink').setAttribute('visible', 'false');
                document.getElementById('right-eye-blink').setAttribute('visible', 'false');
            });
        }

        if (window.smileAnimation) {
            window.smileAnimation.finished.then(() => {
                isAnimationPlaying = false;
                document.getElementById('mouth').setAttribute('visible', 'false');
            });
        }

        if (window.winkAnimation) {
            window.winkAnimation.finished.then(() => {
                isAnimationPlaying = false;
                document.getElementById('right-eye-blink').setAttribute('visible', 'false');
            });
        }

        // Автостарт на десктопах
        window.onload = function() {
            if (!/Android|iPhone|iPad/i.test(navigator.userAgent)) {
                updateStatus('Ожидание загрузки...');
            } else {
                updateStatus('Наведите камеру на портрет');
            }
        };
    </script>
</body>
</html>
