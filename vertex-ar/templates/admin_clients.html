<!DOCTYPE html>
<html lang="ru" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Vertex AR - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏ –∏ –∫–æ–º–ø–∞–Ω–∏—è–º–∏">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏ - Vertex AR</title>

    <style>
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #2a2a2a;
            --dark-color: #343a40;
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --border-color: #444;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            --transition-speed: 0.3s;
        }

        [data-theme="light"] {
            --bg-color: #f5f7fa;
            --text-color: #333;
            --border-color: #ddd;
            --light-color: #ffffff;
            --dark-color: #343a40;
            --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
            padding: 0 1rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .header h1 {
            color: var(--text-color);
            font-size: 1.5rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            background: none;
            border: 2px solid var(--border-color);
            color: var(--text-color);
            padding: 0.5rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1.2rem;
            transition: all var(--transition-speed);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .logout-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color var(--transition-speed);
            text-decoration: none;
            display: inline-block;
        }

        .logout-btn:hover {
            background-color: #c82333;
        }

        .nav-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            flex-wrap: wrap;
        }

        .nav-tab {
            color: var(--text-color);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius);
            transition: all var(--transition-speed);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-tab:hover {
            background-color: var(--light-color);
        }

        .nav-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .section {
            background-color: var(--light-color);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
        }

        .section h2 {
            margin-bottom: 1rem;
            color: var(--text-color);
            font-size: 1.3rem;
        }

        .company-section {
            background-color: var(--light-color);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-bottom: 2rem;
        }

        .company-info {
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .company-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .company-select,
        .company-input {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .company-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all var(--transition-speed);
            background-color: var(--primary-color);
            color: white;
        }

        .company-btn:hover {
            background-color: var(--primary-hover);
        }

        .company-btn.danger {
            background-color: var(--danger-color);
        }

        .company-btn.danger:hover {
            background-color: #c82333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: var(--light-color);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .stat-card h3 {
            font-size: 0.9rem;
            color: var(--secondary-color);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            transition: all var(--transition-speed);
            background-color: var(--primary-color);
            color: white;
        }

        .btn:hover {
            background-color: var(--primary-hover);
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-color);
            font-size: 0.9rem;
        }

        .filter-group input,
        .filter-group select {
            padding: 0.8rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.95rem;
            transition: all var(--transition-speed);
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }

        .clients-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .clients-table thead {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
            border-bottom: 3px solid var(--primary-color);
        }

        .clients-table th {
            padding: 1.2rem 1rem;
            text-align: left;
            font-weight: 700;
            color: white;
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .clients-table td {
            padding: 1.2rem 1rem;
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
        }

        .clients-table tbody tr {
            transition: all var(--transition-speed);
        }

        .clients-table tbody tr:hover {
            background-color: var(--light-color);
            transform: scale(1.01);
            box-shadow: inset 0 0 10px rgba(0, 123, 255, 0.1);
        }

        .clients-table tbody tr:last-child td {
            border-bottom: none;
        }

        .clients-table input[type="checkbox"] {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        .avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--border-color);
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-active {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }

        .status-inactive {
            background-color: rgba(108, 117, 125, 0.2);
            color: var(--secondary-color);
        }

        .action-btn {
            padding: 0.6rem 0.9rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-right: 0.3rem;
            transition: all var(--transition-speed);
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            white-space: nowrap;
        }

        .action-btn.edit {
            background-color: var(--info-color);
            color: white;
        }

        .action-btn.edit:hover {
            background-color: #138496;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.4);
        }

        .action-btn.delete {
            background-color: var(--danger-color);
            color: white;
        }

        .action-btn.delete:hover {
            background-color: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 0.65rem 1.2rem;
            border: 2px solid var(--primary-color);
            background-color: transparent;
            color: var(--primary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all var(--transition-speed);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 44px;
            justify-content: center;
        }

        .pagination button:hover:not(:disabled) {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .pagination button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            border-color: var(--secondary-color);
            color: var(--secondary-color);
        }

        .pagination button.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }

        .pagination-info {
            padding: 0.5rem 1.5rem;
            color: var(--text-color);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-container {
            text-align: center;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: white;
            font-size: 1.2rem;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }

        .toast {
            background-color: var(--light-color);
            color: var(--text-color);
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            box-shadow: var(--box-shadow);
            min-width: 250px;
            opacity: 0;
            transform: translateX(100%);
            transition: all var(--transition-speed);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        .toast.info {
            border-left: 4px solid var(--info-color);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--secondary-color);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .bulk-actions {
            display: none;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            align-items: center;
        }

        .bulk-actions.show {
            display: flex;
        }

        .selected-count {
            font-weight: 600;
            color: var(--primary-color);
        }

        .logs-section {
            background-color: var(--light-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .logs-header h2 {
            color: var(--text-color);
            font-size: 1.3rem;
            margin: 0;
        }

        .log-container {
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1rem;
            height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }

        .log-empty {
            color: var(--secondary-color);
            text-align: center;
            font-style: italic;
            margin: 0;
        }

        .log-entry {
            display: flex;
            align-items: center;
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        /* Footer Styles */
        .footer {
            margin-top: 4rem;
            padding: 2rem 0;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--text-color);
            opacity: 0.7;
            font-size: 0.9rem;
        }

        .footer p {
            margin: 0.5rem 0;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: var(--secondary-color);
            margin-right: 1rem;
            font-size: 0.8rem;
            min-width: 80px;
        }

        .log-message {
            flex: 1;
            color: var(--text-color);
        }

        .log-type {
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
            min-width: 50px;
            text-align: center;
        }

        .log-info .log-type {
            background-color: var(--info-color);
            color: white;
        }

        .log-success .log-type {
            background-color: var(--success-color);
            color: white;
        }

        .log-warning .log-type {
            background-color: var(--warning-color);
            color: black;
        }

        .log-error .log-type {
            background-color: var(--danger-color);
            color: white;
        }

        .footer {
            margin-top: 3rem;
            padding: 2rem 0;
            border-top: 1px solid var(--border-color);
            text-align: center;
            color: var(--secondary-color);
        }

        .footer p {
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        .footer a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color var(--transition-speed);
        }

        .footer a:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }

        .link-button {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 0;
            transition: color var(--transition-speed);
        }

        .link-button:hover {
            color: var(--primary-hover);
            text-decoration: underline;
        }

        .link-button.ghost {
            color: var(--secondary-color);
        }

        .link-button.ghost:hover {
            color: var(--text-color);
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .header-actions {
                justify-content: space-between;
            }

            .header h1 {
                font-size: 1.25rem;
                text-align: center;
            }

            .container {
                padding: 0 0.5rem;
            }

            .clients-table {
                font-size: 0.85rem;
            }

            .clients-table th,
            .clients-table td {
                padding: 0.5rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .filters {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞–º–∏</h1>
            <div class="header-actions">
                <button id="themeToggle" class="theme-toggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåô</button>
                <a href="/admin/logout" class="logout-btn">–í—ã–π—Ç–∏</a>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <a href="/admin" class="nav-tab">üè† Dashboard</a>
            <a href="/admin/clients" class="nav-tab active">üë• –ö–ª–∏–µ–Ω—Ç—ã</a>
            <a href="/admin/backups" class="nav-tab">üîí Backup</a>
        </div>

        <!-- Client Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</h3>
                <div class="value" id="totalClients">0</div>
            </div>
            <div class="stat-card">
                <h3>–í —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏</h3>
                <div class="value" id="companyClients">0</div>
            </div>
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ –∫–æ–º–ø–∞–Ω–∏–π</h3>
                <div class="value" id="totalCompanies">0</div>
            </div>
            <div class="stat-card">
                <h3>–í—Å–µ–≥–æ –ø–æ—Ä—Ç—Ä–µ—Ç–æ–≤</h3>
                <div class="value" id="totalPortraits">0</div>
            </div>
        </div>

        <!-- Filters and Search -->
        <section class="section">
            <h2>üîç –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã</h2>
            <div class="filters">
                <div class="filter-group">
                    <label>–ü–æ–∏—Å–∫</label>
                    <input type="search" id="clientSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É...">
                </div>
                <div class="filter-group">
                    <label>–ö–æ–º–ø–∞–Ω–∏—è</label>
                    <select id="filterCompany">
                        <option value="">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>–ó–∞–ø–∏—Å–µ–π –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ</label>
                    <select id="recordsPerPage">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Bulk Actions -->
        <div class="bulk-actions" id="bulkActions">
            <span class="selected-count">–í—ã–±—Ä–∞–Ω–æ: <span id="selectedCount">0</span></span>
            <button onclick="bulkDeleteClients()" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö</button>
            <button onclick="clearSelection()" class="btn">–û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä</button>
        </div>

        <!-- Clients Table -->
        <section class="section">
            <h2>üìã –°–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤</h2>
            <table class="clients-table">
                <thead>
                    <tr>
                        <th style="width: 40px;">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th style="width: 60px;">–§–æ—Ç–æ</th>
                        <th>–ò–º—è</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                        <th>–ü–æ—Ä—Ç—Ä–µ—Ç–æ–≤</th>
                        <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        <th style="width: 150px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="clientsTableBody">
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <div>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤...</div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Pagination -->
            <div class="pagination" id="pagination"></div>
        </section>

        <!-- Logs Section -->
        <section class="logs-section">
            <div class="logs-header">
                <h2>–°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏</h2>
                <button type="button" id="clearLogsBtn" class="link-button ghost">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <div class="log-container" id="logContainer">
                <p class="log-empty">–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã</p>
            </div>
        </section>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2025 Vertex AR Admin Dashboard. All rights reserved. Version: {{ request.app.state.config.VERSION }}</p>
            <p>
                <a href="/admin">Dashboard</a> |
                <a href="/admin/clients">–ö–ª–∏–µ–Ω—Ç—ã</a> |
                <a href="/admin/backups">Backup</a>
            </p>
        </footer>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-container">
            <div class="loading-spinner"></div>
            <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        let currentPage = 1;
        let pageSize = 25;
        let currentCompanyId = null;
        let allCompanies = [];
        let selectedClients = new Set();

        function showLoading() {
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('admin-theme', newTheme);

            const themeToggle = document.getElementById('themeToggle');
            themeToggle.textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        }

        async function loadCompanies() {
            try {
                const response = await fetch('/companies', {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load companies');
                }

                const data = await response.json();
                allCompanies = data.items || [];

                const filterCompany = document.getElementById('filterCompany');

                filterCompany.innerHTML = '<option value="">–í—Å–µ –∫–æ–º–ø–∞–Ω–∏–∏</option>';

                allCompanies.forEach(company => {
                    const option = new Option(company.name, company.id);
                    filterCompany.add(option);
                });

                if (allCompanies.length > 0) {
                    currentCompanyId = allCompanies[0].id;
                    filterCompany.value = currentCompanyId;
                }

                document.getElementById('totalCompanies').textContent = allCompanies.length;

            } catch (error) {
                console.error('Error loading companies:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–ø–∞–Ω–∏–π', 'error');
            }
        }

        async function loadClients() {
            showLoading();

            try {
                const search = document.getElementById('clientSearch').value;
                const companyFilter = document.getElementById('filterCompany').value;

                let url = `/clients/list?page=${currentPage}&page_size=${pageSize}`;

                if (search) {
                    url += `&search=${encodeURIComponent(search)}`;
                }

                if (companyFilter) {
                    url += `&company_id=${companyFilter}`;
                }

                const response = await fetch(url, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load clients');
                }

                const data = await response.json();

                currentPage = data.page || currentPage;
                renderClients(data.items);
                updatePagination(currentPage, data.total_pages, data.total);

                const companyFilter2 = document.getElementById('filterCompany').value;
                if (companyFilter2) {
                    document.getElementById('companyClients').textContent = data.total;
                }

                const statsResponse = await fetch('/admin/stats', {
                    credentials: 'include'
                });

                if (statsResponse.ok) {
                    const stats = await statsResponse.json();
                    document.getElementById('totalClients').textContent = stats.total_clients || 0;
                    document.getElementById('totalPortraits').textContent = stats.total_portraits || 0;
                }

            } catch (error) {
                console.error('Error loading clients:', error);
                showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤', 'error');

                document.getElementById('clientsTableBody').innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="empty-state-icon">‚ö†Ô∏è</div>
                            <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>
                        </td>
                    </tr>
                `;
            } finally {
                hideLoading();
            }
        }

        function renderClients(clients) {
            const tbody = document.getElementById('clientsTableBody');

            if (!clients || clients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div class="empty-state-icon">üì≠</div>
                            <div>–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = clients.map(client => {
                const companyName = allCompanies.find(c => c.id === client.company_id)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                const date = new Date(client.created_at).toLocaleDateString('ru-RU');
                const avatar = client.latest_portrait_preview || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="50" height="50"><rect width="50" height="50" fill="%23ccc"/><text x="50%" y="50%" text-anchor="middle" dy=".3em" fill="%23666" font-size="20">?</text></svg>';

                return `
                    <tr>
                        <td>
                            <input type="checkbox" class="client-checkbox" data-client-id="${client.id}" onchange="toggleClientSelection('${client.id}')">
                        </td>
                        <td>
                            <img src="${avatar}" alt="${client.name}" class="avatar">
                        </td>
                        <td>${client.name}</td>
                        <td>${client.phone}</td>
                        <td>${companyName}</td>
                        <td>${client.portraits_count || 0}</td>
                        <td>${date}</td>
                        <td>
                            <button class="action-btn edit" onclick="editClient('${client.id}')">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                            <button class="action-btn delete" onclick="deleteClient('${client.id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updatePagination(page, totalPages, total) {
            const pagination = document.getElementById('pagination');
            if (!pagination) {
                return;
            }

            const safeTotalPages = Math.max(1, totalPages || 1);
            currentPage = Math.min(Math.max(page || 1, 1), safeTotalPages);

            pagination.innerHTML = '';

            const prevBtn = createPaginationButton('‚Üê', currentPage - 1, currentPage <= 1);
            pagination.appendChild(prevBtn);

            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(safeTotalPages, startPage + 4);

            for (let i = startPage; i <= endPage; i++) {
                const btn = createPaginationButton(i, i, false, i === currentPage);
                pagination.appendChild(btn);
            }

            const nextBtn = createPaginationButton('‚Üí', currentPage + 1, currentPage >= safeTotalPages);
            pagination.appendChild(nextBtn);

            const info = document.createElement('div');
            info.className = 'pagination-info';
            const totalText = typeof total === 'number' ? ` (${total} –∑–∞–ø–∏—Å–µ–π)` : '';
            info.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${safeTotalPages}${totalText}`;
            pagination.appendChild(info);
        }

        function createPaginationButton(label, targetPage, disabled, isActive = false) {
            const button = document.createElement('button');
            button.textContent = label;
            button.className = 'pagination-btn';

            if (isActive) {
                button.classList.add('active');
            }

            button.disabled = disabled;

            if (!disabled) {
                button.addEventListener('click', () => {
                    currentPage = targetPage;
                    loadClients();
                });
            }

            return button;
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.client-checkbox');

            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
                const clientId = cb.dataset.clientId;
                if (selectAll.checked) {
                    selectedClients.add(clientId);
                } else {
                    selectedClients.delete(clientId);
                }
            });

            updateBulkActions();
        }

        function toggleClientSelection(clientId) {
            if (selectedClients.has(clientId)) {
                selectedClients.delete(clientId);
            } else {
                selectedClients.add(clientId);
            }

            updateBulkActions();
        }

        function updateBulkActions() {
            const bulkActions = document.getElementById('bulkActions');
            const selectedCount = document.getElementById('selectedCount');

            if (selectedClients.size > 0) {
                bulkActions.classList.add('show');
                selectedCount.textContent = selectedClients.size;
            } else {
                bulkActions.classList.remove('show');
            }
        }

        function clearSelection() {
            selectedClients.clear();
            document.querySelectorAll('.client-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAll').checked = false;
            updateBulkActions();
        }

        async function bulkDeleteClients() {
            if (selectedClients.size === 0) {
                showToast('–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                return;
            }

            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${selectedClients.size} –∫–ª–∏–µ–Ω—Ç–æ–≤?`)) {
                return;
            }

            showLoading();

            try {
                const response = await fetch('/clients/bulk-delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ ids: Array.from(selectedClients) })
                });

                if (!response.ok) {
                    throw new Error('Failed to delete clients');
                }

                showToast('–ö–ª–∏–µ–Ω—Ç—ã —É–¥–∞–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
                clearSelection();
                loadClients();

            } catch (error) {
                console.error('Error deleting clients:', error);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤', 'error');
            } finally {
                hideLoading();
            }
        }

        async function deleteClient(clientId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞?')) {
                return;
            }

            showLoading();

            try {
                const response = await fetch(`/clients/${clientId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to delete client');
                }

                showToast('–ö–ª–∏–µ–Ω—Ç —É–¥–∞–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                loadClients();

            } catch (error) {
                console.error('Error deleting client:', error);
                showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞', 'error');
            } finally {
                hideLoading();
            }
        }

        function editClient(clientId) {
            showToast('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
        }

        document.getElementById('clientSearch').addEventListener('input', () => {
            currentPage = 1;
            loadClients();
        });

        document.getElementById('filterCompany').addEventListener('change', () => {
            currentPage = 1;
            loadClients();
        });

        document.getElementById('recordsPerPage').addEventListener('change', (e) => {
            pageSize = parseInt(e.target.value);
            currentPage = 1;
            loadClients();
        });

        document.getElementById('themeToggle').addEventListener('click', toggleTheme);

        (function () {
            const savedTheme = localStorage.getItem('admin-theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const themeToggle = document.getElementById('themeToggle');
            themeToggle.textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        })();

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const emptyMessage = logContainer.querySelector('.log-empty');

            if (emptyMessage) {
                emptyMessage.remove();
            }

            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;

            const time = new Date().toLocaleTimeString('ru-RU');
            const typeLabel = {
                'info': 'INFO',
                'success': 'OK',
                'warning': 'WARN',
                'error': 'ERR'
            }[type] || 'INFO';

            logEntry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-type">${typeLabel}</span>
                <span class="log-message">${message}</span>
            `;

            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            const maxLogs = 50;
            const logs = logContainer.querySelectorAll('.log-entry');
            if (logs.length > maxLogs) {
                logs[0].remove();
            }
        }

        function clearLogs() {
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<p class="log-empty">–õ–æ–≥–∏ –ø–æ—è–≤—è—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã</p>';
            addLog('–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã', 'info');
        }

        document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);

        const originalShowToast = showToast;
        showToast = function (message, type = 'info') {
            originalShowToast(message, type);
            addLog(message, type);
        };

        async function initialize() {
            addLog('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–ª–∏–µ–Ω—Ç–æ–≤', 'info');
            await loadCompanies();
            await loadClients();
            addLog('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
        }

        initialize();
    </script>
</body>

</html>
