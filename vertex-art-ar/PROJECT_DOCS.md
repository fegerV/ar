# Vertex Art AR - Документация проекта (Упрощенная версия)

## Общее описание

Vertex Art AR - это упрощенное веб-приложение для создания и управления AR-контентом. Проект включает в себя веб-интерфейс, систему аутентификации, локальное хранилище файлов и AR-функциональность. Основан на подходах из проекта Stogram для упрощения развертывания и обслуживания.

## Структура проекта

```
vertex-art-ar/
├── .env                    # Конфигурационные переменные окружения
├── start.sh                # Скрипт запуска (упрощенный)
├── main.py                 # Основное приложение FastAPI (упрощенное)
├── requirements-simple.txt # Упрощенные зависимости
├── storage/                # Локальное хранилище файлов
│   ├── ar_content/         # AR-контент пользователей
│   └── nft-markers/        # Сгенерированные NFT-маркеры
├── static/                 # Статические файлы
├── templates/              # HTML-шаблоны
├── nft_marker_generator.py # Генератор NFT-маркеров
├── deploy-simplified.sh    # Упрощенный скрипт деплоя
├── README_DEPLOYMENT.md    # Документация по упрощенному развертыванию
└── Makefile                # Упрощенные команды make
```

## Компоненты системы

### 1. Веб-приложение (main.py)
- Основное FastAPI приложение с упрощенной архитектурой
- Обработка маршрутов для аутентификации, загрузки файлов, AR-функций
- Использование SQLite вместо PostgreSQL
- Локальное хранение файлов вместо MinIO

### 2. Аутентификация
- Регистрация и вход пользователей
- Простые токены (не JWT) для аутентификации
- Роли пользователей (обычный пользователь, администратор)

### 3. Хранилище
- Локальное файловое хранилище вместо MinIO
- Загрузка и извлечение медиафайлов напрямую из файловой системы
- Упрощенное управление файлами

### 4. База данных
- SQLite вместо PostgreSQL
- Упрощенные модели пользователей и AR-контента
- Без сложных ORM-отношений

### 5. Генерация NFT-маркеров (nft_marker_generator.py)
- Создание AR.js NFT-маркеров из загруженных изображений
- Без интеграции с блокчейном
- Сохранение маркеров в локальное хранилище

### 6. AR-функциональность
- Отображение AR-контента
- Интеграция с AR.js и A-Frame
- Взаимодействие с 3D-объектами через веб-камеру

## Упрощения по сравнению с оригинальной версией

| Компонент | Оригинал | Упрощенная версия |
|-----------|----------|-------------------|
| База данных | PostgreSQL + SQLAlchemy | SQLite |
| Хранилище | MinIO | Локальная файловая система |
| Аутентификация | JWT-токены | Простые токены в памяти |
| Зависимости | 15 | 7 |
| Внешние сервисы | 3 (MinIO, PostgreSQL) | 0 |
| Контейнеры | 4 | 2 |

## Текущие задачи для реализации

### Необходимо реализовать

- [x] Добавить валидацию файлов при загрузке
- [x] Реализовать систему превью для загружаемых файлов
- [x] Добавить функцию редактирования медиафайлов
- [x] Реализовать систему тегов и категорий для файлов
- [x] Добавить функцию публикации файлов в AR-галерею
- [x] Реализовать систему рейтинга и комментариев
- [ ] Добавить интеграцию с криптокошельками
- [x] Реализовать систему уведомлений
- [x] Добавить админ-панель для управления контентом
- [ ] Реализовать функцию экспорта данных пользователя
- [ ] Добавить функцию массовой загрузки файлов
- [x] Реализовать систему бэкапа данных
- [x] Добавить логирование операций
- [ ] Реализовать систему кэширования
- [ ] Добавить функцию поиска по контенту
- [ ] Реализовать мультиязычную поддержку

### Технические задачи

- [x] Оптимизировать загрузку больших файлов
- [x] Реализовать сжатие изображений
- [x] Добавить обработку видеофайлов
- [ ] Реализовать CDN для статических файлов
- [ ] Добавить мониторинг производительности
- [ ] Реализовать автоматическое масштабирование
- [x] Добавить систему резервного копирования
- [x] Реализовать безопасность на уровне API
- [ ] Добавить систему аудита действий пользователей

### Тестирование

- [ ] Написать интеграционные тесты
- [ ] Реализовать нагрузочное тестирование
- [x] Добавить автоматические тесты для AR-функций
- [x] Реализовать тесты безопасности
- [ ] Добавить тесты для NFT-генерации

## Технологии

- Python (FastAPI)
- SQLite (встроенная база данных)
- Локальное файловое хранилище
- Простая аутентификация
- Docker (контейнеризация)
- JavaScript (фронтенд)
- HTML/CSS (веб-интерфейс)
- AR.js/A-Frame (AR-функциональность)

## Переменные окружения

- `DATABASE_URL` - URL базы данных (для совместимости)
- `STORAGE_ROOT` - корневая директория хранилища
- `SECRET_KEY` - ключ для аутентификации

## Запуск приложения

### Упрощенный запуск
```bash
cd vertex-art-ar
./start.sh
```

### Запуск с Docker
```bash
docker compose up --build
```

### Ручной запуск
```bash
cd vertex-art-ar
pip install -r requirements-simple.txt
uvicorn main:app --host 127.0.0.1 --port 8000 --reload
```

## Тестирование

```bash
python -m pytest tests/
```

## Деплой

### Упрощенный деплой
```bash
make deploy
# или
./deploy-simplified.sh
```

## Статусы задач

- [ ] Не начато
- [x] Выполнено
- [-] В процессе
- [/] Частично выполнено

## Дополнительные заметки

- Приложение запускается на порту 8000
- Используется локальное файловое хранилище вместо MinIO
- В проекте есть файлы для тестирования и документации
- Поддержка AR-функций через HTML-страницу
- Без интеграции с системой NFT и блокчейном

## Валидация файлов при загрузке

### Описание реализованной валидации

При загрузке файлов (изображений и видео) реализована многоуровневая валидация для обеспечения безопасности и корректности загружаемого контента. Валидация включает в себя следующие проверки:

#### 1. Проверка размера файлов
- Максимальный размер изображения: 50 МБ
- Максимальный размер видео: 50 МБ
- Проверка на пустые файлы (размер 0 байт)

#### 2. Проверка типов файлов
- Изображения: только JPEG и PNG форматы
- Видео: только MP4 формат
- Используется библиотека `python-magic` для безопасного определения MIME-типов по содержимому файла
- Резервные методы проверки с использованием `imghdr` и сигнатурных байтов MP4

#### 3. Проверка содержимого файлов
- Проверка целостности изображений с помощью PIL
- Проверка минимального разрешения изображений (не менее 1024 пикселей по одной из сторон)
- Проверка корректности MP4-файлов по сигнатуре заголовка
- Защита от загрузки вредоносных файлов с поддельным расширением

#### 4. Дополнительные проверки
- Проверка на корректность содержимого (изображение не повреждено)
- Безопасное определение типа файла по содержимому, а не по расширению
- Обработка исключений при валидации для предотвращения сбоев приложения
