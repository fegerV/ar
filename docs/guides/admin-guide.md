# Руководство администратора Vertex AR

## Содержание
1. [Введение](#введение)
2. [Первоначальная настройка](#первоначальная-настройка)
3. [Вход в систему](#вход-в-систему)
4. [Административная панель](#административная-панель)
5. [Управление AR контентом](#управление-ar-контентом)
6. [Мониторинг системы](#мониторинг-системы)
7. [Статистика и аналитика](#статистика-и-аналитика)
8. [Удаление контента](#удаление-контента)
9. [Резервное копирование](#резервное-копирование)
10. [Устранение неполадок](#устранение-неполадок)

---

## Введение

Vertex AR - это система для создания и управления AR (дополненная реальность) контентом. Система позволяет загружать изображения и видео, которые затем преобразуются в AR-опыт с использованием NFT-маркеров.

Система поддерживает **только одного администратора**, который имеет полный доступ ко всем функциям.

---

## Первоначальная настройка

### Создание учетной записи администратора

При первом запуске системы необходимо создать учетную запись администратора:

```bash
# Используя cURL
curl -X POST "http://localhost:8000/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "your_secure_password"
  }'
```

**Важно**: 
- Используйте надежный пароль (минимум 12 символов)
- Сохраните учетные данные в безопасном месте
- Первый зарегистрированный пользователь автоматически получает права администратора

### Настройка окружения

Создайте файл `.env` в директории `vertex-ar/`:

```bash
BASE_URL=https://your-domain.com
DATABASE_URL=sqlite:///./app_data.db
```

---

## Вход в систему

### Через API

```bash
curl -X POST "http://localhost:8000/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "your_password"
  }'
```

Ответ:
```json
{
  "access_token": "your_token_here",
  "token_type": "bearer"
}
```

### Через административную панель

1. Откройте браузер и перейдите по адресу: `http://localhost:8000/admin`
2. В панели используйте JavaScript консоль или интерфейс для аутентификации
3. Сохраните токен для последующих запросов

---

## Административная панель

Административная панель доступна по адресу: `/admin`

### Основные разделы

1. **Статистика системы** - общая информация о системе
2. **Информация о диске** - свободное и занятое дисковое пространство
3. **Загрузка контента** - форма для загрузки нового AR контента
4. **Список контента** - все загруженные AR элементы
5. **Статистика просмотров** - счетчики открытий и переходов

### Информация о дисковом пространстве

В административной панели отображается:

- **Общее дисковое пространство** - общий размер диска
- **Использовано** - занятое пространство
- **Свободно** - доступное пространство
- **Процент использования** - визуализация в виде прогресс-бара
- **Размер хранилища** - размер директории `storage/`
- **Количество файлов** - общее количество файлов в хранилище

---

## Управление AR контентом

### Загрузка нового AR контента

#### Через API

```bash
curl -X POST "http://localhost:8000/ar/upload" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "image=@/path/to/image.jpg" \
  -F "video=@/path/to/video.mp4"
```

#### Через административную панель

1. Перейдите в раздел "Загрузка контента"
2. Выберите изображение (файл-маркер для AR)
3. Выберите видео (контент, который будет отображаться в AR)
4. Нажмите "Загрузить"

**Что происходит при загрузке:**

1. Файлы сохраняются в `storage/ar_content/username/content_id/`
2. Автоматически создаются превью изображения и видео
3. Генерируются NFT-маркеры для AR.js (fset, fset3, iset файлы)
4. Создается QR-код для быстрого доступа
5. Контент добавляется в базу данных

### Превью загруженных файлов

Система автоматически генерирует превью для:

- **Изображений** - миниатюра размером 200x200px
- **Видео** - статичное изображение с иконкой воспроизведения

Превью хранятся в той же директории что и основные файлы:
- `{content_id}_preview.jpg` - превью изображения
- `{content_id}_video_preview.jpg` - превью видео

### Требования к файлам

**Изображение:**
- Форматы: JPG, PNG
- Рекомендуемый размер: 1024x1024px или больше
- Максимальный размер: зависит от настроек сервера
- Качество: высокое разрешение для лучшего распознавания

**Видео:**
- Форматы: MP4, WebM
- Рекомендуемое разрешение: 720p или 1080p
- Кодек: H.264
- Длительность: не более 60 секунд (рекомендация)

---

## Мониторинг системы

### Получение информации о системе

```bash
curl -X GET "http://localhost:8000/admin/system-info" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

Ответ:
```json
{
  "disk_info": {
    "total": "500.00 GB",
    "used": "250.00 GB",
    "free": "250.00 GB",
    "used_percent": 50.0
  },
  "storage_info": {
    "total_size": "10.50 GB",
    "file_count": 245,
    "path": "storage/"
  }
}
```

### Получение детальной информации о хранилище

```bash
curl -X GET "http://localhost:8000/admin/storage-info" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Мониторинг в реальном времени

Административная панель обновляет информацию автоматически каждые 30 секунд.

**Рекомендации по мониторингу:**

- Следите за свободным дисковым пространством (должно быть > 10%)
- Регулярно проверяйте количество файлов
- При достижении 80% использования диска рассмотрите очистку старого контента

---

## Статистика и аналитика

### Счетчики AR контента

Для каждого AR элемента отслеживаются:

1. **Счетчик просмотров (view_count)** - увеличивается при каждом открытии AR страницы
2. **Счетчик кликов (click_count)** - увеличивается при взаимодействии с контентом

### Автоматическое отслеживание

**Просмотры** отслеживаются автоматически при открытии URL:
```
GET /ar/{content_id}
```

**Клики** отслеживаются через API:
```bash
curl -X POST "http://localhost:8000/ar/{content_id}/click"
```

### Получение статистики

```bash
curl -X GET "http://localhost:8000/admin/content-stats" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

Ответ:
```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "title": "550e8400-e29b-41d4-a716-446655440000",
    "views": 150,
    "clicks": 45,
    "created_at": "2024-01-15T10:30:00",
    "ar_url": "http://localhost:8000/ar/550e8400-e29b-41d4-a716-446655440000"
  }
]
```

### Интерпретация статистики

- **Высокий показатель просмотров** - контент интересен пользователям
- **Низкий показатель кликов при высоких просмотрах** - возможно, контент не привлекателен
- **Соотношение кликов к просмотрам** - показатель вовлеченности (CTR)

---

## Удаление контента

### Через API

```bash
curl -X DELETE "http://localhost:8000/ar/{content_id}" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### Что удаляется

1. Все файлы в директории контента:
   - Оригинальное изображение
   - Оригинальное видео
   - Превью изображения
   - Превью видео
   - NFT-маркеры (fset, fset3, iset)

2. Запись в базе данных со всей метаинформацией

**Важно:** Удаление необратимо! Убедитесь, что у вас есть резервная копия, если контент может понадобиться в будущем.

### Массовое удаление

Для удаления нескольких элементов используйте скрипт:

```bash
#!/bin/bash
TOKEN="your_token_here"

for id in "id1" "id2" "id3"; do
  curl -X DELETE "http://localhost:8000/ar/${id}" \
    -H "Authorization: Bearer ${TOKEN}"
  echo "Deleted: ${id}"
done
```

---

## Резервное копирование

### База данных

Создайте резервную копию SQLite базы данных:

```bash
# Копирование файла базы данных
cp vertex-ar/app_data.db vertex-ar/backups/app_data_$(date +%Y%m%d).db

# Или используйте sqlite3 для создания дампа
sqlite3 vertex-ar/app_data.db ".backup 'backup.db'"
```

### Файлы хранилища

Создайте резервную копию директории storage:

```bash
# Архивация с сжатием
tar -czf storage_backup_$(date +%Y%m%d).tar.gz vertex-ar/storage/

# Синхронизация с удаленным сервером
rsync -avz vertex-ar/storage/ user@backup-server:/backups/vertex-ar/
```

### Автоматизация резервного копирования

Создайте cron задачу для автоматического резервного копирования:

```bash
# Редактировать crontab
crontab -e

# Добавить строку для ежедневного бэкапа в 2:00 AM
0 2 * * * /path/to/backup-script.sh
```

Пример скрипта резервного копирования (`backup-script.sh`):

```bash
#!/bin/bash
BACKUP_DIR="/backups/vertex-ar"
DATE=$(date +%Y%m%d_%H%M%S)

# Создать директорию для бэкапов
mkdir -p ${BACKUP_DIR}

# Бэкап базы данных
cp /path/to/vertex-ar/app_data.db ${BACKUP_DIR}/app_data_${DATE}.db

# Бэкап файлов
tar -czf ${BACKUP_DIR}/storage_${DATE}.tar.gz /path/to/vertex-ar/storage/

# Удалить старые бэкапы (старше 30 дней)
find ${BACKUP_DIR} -type f -mtime +30 -delete

echo "Backup completed: ${DATE}"
```

---

## Устранение неполадок

### Проблема: Не создаются превью

**Симптомы:** После загрузки файлов отсутствуют превью

**Решение:**
1. Проверьте логи:
```bash
tail -f /var/log/vertex-ar/app.log
```

2. Убедитесь, что установлена библиотека Pillow:
```bash
pip install Pillow
```

3. Проверьте права доступа к директории storage:
```bash
chmod -R 755 vertex-ar/storage/
```

### Проблема: Закончилось дисковое пространство

**Симптомы:** Ошибки при загрузке новых файлов

**Решение:**
1. Проверьте свободное место:
```bash
df -h
```

2. Удалите старый или неиспользуемый контент
3. Очистите старые превью
4. Рассмотрите увеличение дискового пространства

### Проблема: Не работают NFT-маркеры

**Симптомы:** AR не распознает изображение

**Решение:**
1. Используйте изображения высокого качества
2. Убедитесь, что изображение содержит достаточно деталей
3. Проверьте, что NFT-маркеры сгенерированы:
```bash
ls -la vertex-ar/storage/ar_content/*/markers/
```

### Проблема: Счетчики не обновляются

**Симптомы:** view_count и click_count не изменяются

**Решение:**
1. Проверьте, что база данных обновлена до последней схемы
2. Перезапустите приложение:
```bash
systemctl restart vertex-ar
```

3. Проверьте целостность базы данных:
```bash
sqlite3 vertex-ar/app_data.db "PRAGMA integrity_check;"
```

### Проблема: Не удается удалить контент

**Симптомы:** Ошибка при попытке удаления

**Решение:**
1. Проверьте права доступа:
```bash
ls -la vertex-ar/storage/ar_content/
```

2. Убедитесь, что файлы не используются другим процессом:
```bash
lsof | grep storage
```

3. Попробуйте удалить вручную:
```bash
rm -rf vertex-ar/storage/ar_content/{content_id}/
```

### Получение помощи

Если проблема не решается:

1. Проверьте документацию: `/docs` или `/redoc`
2. Изучите логи приложения
3. Проверьте GitHub Issues проекта
4. Обратитесь к разработчикам

---

## Безопасность

### Рекомендации по безопасности

1. **Пароли**
   - Используйте сложные пароли (минимум 12 символов)
   - Регулярно меняйте пароль (раз в 90 дней)
   - Не передавайте пароль третьим лицам

2. **Токены доступа**
   - Храните токены в безопасном месте
   - Не передавайте токены по незащищенным каналам
   - При компрометации сразу перелогиньтесь для получения нового токена

3. **HTTPS**
   - Всегда используйте HTTPS в продакшене
   - Настройте SSL-сертификаты (Let's Encrypt)

4. **Firewall**
   - Ограничьте доступ к API только для необходимых IP
   - Используйте fail2ban для защиты от брутфорса

5. **Обновления**
   - Регулярно обновляйте систему
   - Следите за обновлениями зависимостей

### Аудит безопасности

Регулярно проверяйте:
- Логи доступа
- Неудачные попытки входа
- Необычную активность в статистике

---

## Производительность

### Оптимизация

1. **База данных**
   - Регулярно выполняйте VACUUM для SQLite:
   ```bash
   sqlite3 vertex-ar/app_data.db "VACUUM;"
   ```

2. **Файлы**
   - Используйте SSD для хранения
   - Настройте кэширование на уровне веб-сервера (nginx/apache)

3. **Превью**
   - Превью генерируются один раз при загрузке
   - Размер превью оптимизирован (200x200px)

### Масштабирование

При росте нагрузки:
1. Используйте CDN для статических файлов
2. Рассмотрите использование PostgreSQL вместо SQLite
3. Настройте балансировку нагрузки
4. Используйте Redis для кэширования

---

## Заключение

Это руководство охватывает основные аспекты администрирования Vertex AR. При возникновении вопросов обращайтесь к документации API или к техническому руководству разработчика.

**Важные ссылки:**
- API документация: `/docs`
- Интерактивная документация: `/redoc`
- GitHub репозиторий: [ссылка на репозиторий]

Удачной работы с Vertex AR!
