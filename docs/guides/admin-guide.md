# Руководство администратора Vertex AR

## Содержание
1. [Введение](#введение)
2. [Первоначальная настройка](#первоначальная-настройка)
3. [Вход в систему](#вход-в-систему)
4. [Административная панель](#административная-панель)
5. [Управление пользователями](#управление-пользователями)
6. [Управление AR контентом](#управление-ar-контентом)
7. [Мониторинг системы](#мониторинг-системы)
8. [Статистика и аналитика](#статистика-и-аналитика)
9. [Удаление контента](#удаление-контента)
10. [Резервное копирование](#резервное-копирование)
11. [Устранение неполадок](#устранение-неполадок)
12. [Безопасность](#безопасность)
13. [Производительность](#производительность)
14. [Заключение](#заключение)

---

## Введение

Vertex AR — это система для создания и управления AR (дополненной реальности) контентом. Платформа позволяет загружать изображения и видео, которые преобразуются в AR-опыт с использованием NFT-маркеров и QR-кодов.

Система использует ролевую модель доступа. Первый зарегистрированный пользователь автоматически получает права администратора. Позднее администраторы могут создавать неограниченное число дополнительных учетных записей, выдавать или отзывать административные права и управлять жизненным циклом пользователей. Подробности описаны в [руководстве по управлению пользователями](./USER_MANAGEMENT.md).

Ключевые возможности администратора:

- Загрузка, предпросмотр и публикация AR-контента.
- Управление пользователями и ролями.
- Мониторинг системных ресурсов и хранилища.
- Получение статистики просмотров и кликов.
- Настройка процессов резервного копирования и аудит безопасности.

---

## Первоначальная настройка

### Создание учетной записи администратора

При развёртывании версии 1.3.0+ система автоматически создаёт суперпользователя `superar` с паролем `ffE48f0ns@HQ` и полными административными привилегиями. Рекомендуется войти под этой учетной записью, изменить пароль и затем создать собственных администраторов. При необходимости вы можете вручную создать нового администратора:

```bash
# Используя cURL
curl -X POST "http://localhost:8000/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "your_secure_password",
    "email": "admin@example.com",
    "full_name": "Admin User"
  }'
```

**Важно**: 

- Используйте надежный пароль (рекомендуется 12+ символов).
- `email` и `full_name` — необязательные, но полезные поля для аудита.
- Первый зарегистрированный пользователь получает роль администратора автоматически.
- Повторная регистрация того же имени пользователя вернет ошибку `409 Conflict`.
- После появления первого администратора все следующие регистрации создают обычных пользователей; повысить их до администратора можно через API управления пользователями.

### Настройка окружения

Создайте файл `.env` в директории `vertex-ar/` (или дополните существующий):

```bash
BASE_URL=http://localhost:8000
DATABASE_URL=sqlite:///./app_data.db
SESSION_TIMEOUT_MINUTES=30
AUTH_MAX_ATTEMPTS=5
AUTH_LOCKOUT_MINUTES=15
RATE_LIMIT_ENABLED=true
GLOBAL_RATE_LIMIT=100/minute
AUTH_RATE_LIMIT=5/minute
UPLOAD_RATE_LIMIT=10/minute
```

Параметры можно корректировать под свои требования. Если файл `.env` отсутствует, система использует значения по умолчанию.

---

## Вход в систему

### Через API

```bash
curl -X POST "http://localhost:8000/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "your_secure_password"
  }'
```

**Ответ:**
```json
{
  "access_token": "your_token_here",
  "token_type": "bearer"
}
```

### Выход из системы

Для завершения сессии отзовите токен:

```bash
curl -X POST "http://localhost:8000/auth/logout" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

Ответ `204 No Content` означает, что токен больше не действителен.

### Использование токена в административной панели

Административная панель ожидает токен в `localStorage` браузера под ключом `auth_token`.

1. Получите `access_token` через `/auth/login`.
2. Откройте `http://localhost:8000/admin`.
3. В консоли браузера выполните:

   ```javascript
   localStorage.setItem('auth_token', 'PASTE_ACCESS_TOKEN_HERE');
   ```

4. Обновите страницу. При необходимости повторите процедуру после истечения токена (по умолчанию 30 минут бездействия).

---

## Административная панель

Панель доступна по адресу `/admin`. После сохранения токена доступны следующие разделы:

1. **Статистика системы** — общее состояние сервиса.
2. **Информация о диске** — обзоры свободного/занятого места и размера хранилища.
3. **Загрузка контента** — форма добавления AR-материалов.
4. **Список контента** — просмотр и управление загруженными элементами.
5. **Статистика просмотров** — ключевые метрики по каждому AR-объекту.

Интерфейс автоматически обновляет критичные показатели (добавляя защиту от устаревших данных). Операции загрузки и удаления используют те же REST API, что и примеры ниже, поэтому токен в `Authorization` обязателен.

---

## Управление пользователями

Подробная документация доступна в [USER_MANAGEMENT.md](./USER_MANAGEMENT.md). Ниже — основные действия администратора. Все запросы требуют заголовка `Authorization: Bearer ADMIN_TOKEN`.

### Просмотр и поиск пользователей

```bash
# Список пользователей с пагинацией и фильтрами
curl -X GET "http://localhost:8000/users/users?limit=50&offset=0" \
  -H "Authorization: Bearer ADMIN_TOKEN"

# Фильтр только по активным администраторам
curl -X GET "http://localhost:8000/users/users?is_admin=true&is_active=true" \
  -H "Authorization: Bearer ADMIN_TOKEN"

# Поиск по имени пользователя, email или ФИО
curl -X GET "http://localhost:8000/users/users/search?query=alex" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

### Создание пользователя

```bash
curl -X POST "http://localhost:8000/users/users" \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "editor",
    "password": "strong_password_123",
    "email": "editor@example.com",
    "full_name": "Editor User"
  }'
```

Новые пользователи создаются без административных прав. После создания пользователь может войти и сменить пароль в любой момент.

### Изменение роли и статуса

```bash
# Повышение пользователя до администратора и обновление ФИО
curl -X PUT "http://localhost:8000/users/users/editor" \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "is_admin": true,
    "full_name": "Editor Admin"
  }'
```

Администратор не может редактировать или удалять собственную учетную запись через эти эндпоинты — для личных изменений используйте `/users/profile` и `/users/change-password`.

### Деактивация и повторная активация

Удаление выполняется мягко и переводит учетную запись в неактивное состояние:

```bash
curl -X DELETE "http://localhost:8000/users/users/editor" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

Чтобы восстановить доступ, отправьте запрос:

```bash
curl -X PUT "http://localhost:8000/users/users/editor" \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"is_active": true}'
```

После деактивации система автоматически отзывает все действующие токены пользователя.

### Статистика пользователей

```bash
curl -X GET "http://localhost:8000/users/stats" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

В ответе возвращаются `total_users`, `active_users`, `admin_users` и количество недавних входов (`recent_logins`).

### Самообслуживание пользователя

Пользователи (включая администраторов) могут просматривать и обновлять собственные данные:

```bash
# Просмотр профиля
curl -X GET "http://localhost:8000/users/profile" \
  -H "Authorization: Bearer USER_TOKEN"

# Обновление email/ФИО
curl -X PUT "http://localhost:8000/users/profile" \
  -H "Authorization: Bearer USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"email": "new@example.com"}'

# Смена пароля
curl -X POST "http://localhost:8000/users/change-password" \
  -H "Authorization: Bearer USER_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "current_password": "old_password",
    "new_password": "new_secure_password"
  }'
```

---

## Управление AR контентом

### Загрузка нового AR контента

#### Через API

```bash
curl -X POST "http://localhost:8000/ar/upload" \
  -H "Authorization: Bearer ADMIN_TOKEN" \
  -F "image=@/path/to/image.jpg" \
  -F "video=@/path/to/video.mp4"
```

Только администраторы могут загружать контент. После успешной загрузки возвращается идентификатор, URL для просмотра и QR-код в Base64.

#### Через административную панель

1. Сохраните токен администратора в `localStorage` (см. раздел [Вход в систему](#вход-в-систему)).
2. Перейдите в раздел «Загрузка контента».
3. Выберите изображение-маркер и видео.
4. Нажмите «Upload & Create NFT».

**Что происходит при загрузке:**

1. Файлы сохраняются в `storage/ar_content/<username>/<content_id>/`.
2. Создаются превью изображения и видео (200x200 px).
3. Генерируются NFT-маркеры (`.fset`, `.fset3`, `.iset`).
4. Создается QR-код для быстрого доступа (`/ar/{content_id}`).
5. Контент регистрируется в базе данных.

### Превью загруженных файлов

Превью сохраняются рядом с оригинальными файлами:

- `{content_id}_preview.jpg` — изображение.
- `{content_id}_video_preview.jpg` — видео-заглушка.

### Требования к файлам

**Изображения:**

- Форматы: JPG, PNG.
- Рекомендуемый размер: ≥ 1024×1024 px.
- Высокая контрастность повышает качество распознавания.

**Видео:**

- Форматы: MP4, WebM.
- Рекомендуемое разрешение: 720p/1080p.
- Кодек: H.264.
- Длительность: до 60 секунд (рекомендация).

---

## Мониторинг системы

### Получение информации о системе

```bash
curl -X GET "http://localhost:8000/admin/system-info" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

**Пример ответа:**
```json
{
  "disk_info": {
    "total": "500.00 GB",
    "used": "250.00 GB",
    "free": "250.00 GB",
    "used_percent": 50.0
  },
  "storage_info": {
    "total_size": "10.50 GB",
    "file_count": 245,
    "path": "storage/"
  }
}
```

### Получение детальной информации о хранилище

```bash
curl -X GET "http://localhost:8000/admin/storage-info" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

### Мониторинг в реальном времени

Панель обновляет ключевые метрики каждые 30 секунд.

**Рекомендации:**

- Поддерживайте свободное дисковое пространство > 10%.
- Контролируйте рост количества файлов.
- При достижении 80% использования ресурсов планируйте расширение или очистку.

---

## Статистика и аналитика

### Счетчики AR контента

Для каждого AR-элемента отслеживаются:

1. **`view_count`** — увеличивается при открытии `/ar/{content_id}`.
2. **`click_count`** — увеличивается при вызове `/ar/{content_id}/click`.

### Получение статистики

```bash
curl -X GET "http://localhost:8000/admin/content-stats" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

**Пример ответа:**
```json
[
  {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "title": "550e8400-e29b-41d4-a716-446655440000",
    "views": 150,
    "clicks": 45,
    "created_at": "2024-01-15T10:30:00",
    "ar_url": "http://localhost:8000/ar/550e8400-e29b-41d4-a716-446655440000"
  }
]
```

### Интерпретация

- Высокие просмотры при низких кликах могут указывать на недостаточную вовлеченность.
- Контролируйте CTR (отношение кликов к просмотрам) для оценки качества контента.
- Используйте данные для планирования кампаний и обновления материалов.

---

## Удаление контента

### Через API

```bash
curl -X DELETE "http://localhost:8000/ar/{content_id}" \
  -H "Authorization: Bearer ADMIN_TOKEN"
```

### Что удаляется

1. Оригинальные файлы изображения и видео.
2. Сгенерированные превью.
3. NFT-маркеры (`.fset`, `.fset3`, `.iset`).
4. Запись в базе данных со всей метаинформацией.

**Важно:** операция необратима. Подготовьте резервную копию, если контент может понадобиться позже.

### Массовое удаление

```bash
#!/bin/bash
TOKEN="your_admin_token"

for id in "id1" "id2" "id3"; do
  curl -X DELETE "http://localhost:8000/ar/${id}" \
    -H "Authorization: Bearer ${TOKEN}"
  echo "Deleted: ${id}"
done
```

---

## Резервное копирование

### База данных

```bash
# Создание каталога для резервных копий (если отсутствует)
mkdir -p vertex-ar/backups

# Копирование файла базы данных
cp vertex-ar/app_data.db vertex-ar/backups/app_data_$(date +%Y%m%d).db

# Создание дампа через sqlite3
sqlite3 vertex-ar/app_data.db ".backup 'backup.db'"
```

### Файлы хранилища

```bash
# Архивирование сжатым архивом
tar -czf storage_backup_$(date +%Y%m%d).tar.gz vertex-ar/storage/

# Синхронизация на удаленный сервер
rsync -avz vertex-ar/storage/ user@backup-server:/backups/vertex-ar/
```

### Автоматизация резервного копирования

```bash
# Редактирование crontab
crontab -e

# Добавить строку для ежедневного бэкапа в 02:00
0 2 * * * /path/to/backup-script.sh
```

**Пример `backup-script.sh`:**

```bash
#!/bin/bash
BACKUP_DIR="/backups/vertex-ar"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p "${BACKUP_DIR}"

cp /path/to/vertex-ar/app_data.db "${BACKUP_DIR}/app_data_${DATE}.db"
tar -czf "${BACKUP_DIR}/storage_${DATE}.tar.gz" /path/to/vertex-ar/storage/

# Очистка старых резервных копий (старше 30 дней)
find "${BACKUP_DIR}" -type f -mtime +30 -delete

echo "Backup completed: ${DATE}"
```

---

## Устранение неполадок

### Проблема: Не создаются превью

**Симптомы:** превью изображений/видео не появляются.

**Решение:**
1. Проверьте логи:
   ```bash
   tail -f /var/log/vertex-ar/app.log
   ```
2. Убедитесь, что установлена библиотека Pillow:
   ```bash
   pip install Pillow
   ```
3. Проверьте права доступа на `vertex-ar/storage/`:
   ```bash
   chmod -R 755 vertex-ar/storage/
   ```

### Проблема: Закончилось дисковое пространство

**Симптомы:** ошибки при загрузке или генерации контента.

**Решение:**
1. Проверьте свободное место:
   ```bash
   df -h
   ```
2. Удалите устаревший контент.
3. Очистите неиспользуемые превью.
4. Расширьте дисковое пространство.

### Проблема: Не работают NFT-маркеры

**Симптомы:** AR-сцена не распознает изображение.

**Решение:**
1. Используйте изображение высокого качества с уникальными деталями.
2. Убедитесь, что маркеры сгенерированы:
   ```bash
   ls -la vertex-ar/storage/ar_content/*/markers/
   ```
3. Проверяйте журналы генератора NFT.

### Проблема: Счетчики не обновляются

**Симптомы:** `view_count` и `click_count` не меняются.

**Решение:**
1. Убедитесь, что база данных обновлена до последней схемы.
2. Перезапустите приложение:
   ```bash
   systemctl restart vertex-ar
   ```
3. Проверьте целостность базы:
   ```bash
   sqlite3 vertex-ar/app_data.db "PRAGMA integrity_check;"
   ```

### Проблема: Не удается удалить контент

**Симптомы:** ошибки при вызове DELETE.

**Решение:**
1. Проверьте права доступа:
   ```bash
   ls -la vertex-ar/storage/ar_content/
   ```
2. Убедитесь, что файлы не заняты другим процессом:
   ```bash
   lsof | grep storage
   ```
3. При необходимости удалите директорию вручную:
   ```bash
   rm -rf vertex-ar/storage/ar_content/{content_id}/
   ```

### Проблема: Учетная запись заблокирована (`423 Locked`)

**Симптомы:** `/auth/login` возвращает `423 Locked`.

**Решение:**
1. Подождите истечения блокировки (по умолчанию 15 минут).
2. После ожидания выполните вход с корректным паролем — счетчик попыток сбросится автоматически.
3. При необходимости администратор может временно деактивировать пользователя и создать новую учетную запись.

### Проблема: Ошибка `429 Too Many Requests`

**Симптомы:** API отвечает `429`.

**Решение:**
1. Учитывайте лимиты (`AUTH_RATE_LIMIT`, `GLOBAL_RATE_LIMIT`, `UPLOAD_RATE_LIMIT`).
2. Подождите несколько минут и повторите запрос.
3. При необходимости отрегулируйте значения в `.env`.

### Получение помощи

1. Ознакомьтесь с документацией `/docs` или `/redoc`.
2. Изучите журналы приложения.
3. Проверьте открытые issues в репозитории.
4. Обратитесь к команде разработки.

---

## Безопасность

### Рекомендации

1. **Пароли**
   - Используйте сложные уникальные пароли.
   - Обновляйте пароли каждые 90 дней.
   - Не передавайте учетные данные третьим лицам.

2. **Токены доступа**
   - Храните токены в защищенных хранилищах.
   - Отзывайте токены (`/auth/logout`) при подозрении на компрометацию.
   - Не вставляйте токены в публичные скрипты или журналы.

3. **HTTPS**
   - Используйте HTTPS в продакшене.
   - Настройте SSL-сертификаты (например, Let's Encrypt).

4. **Firewall**
   - Ограничьте доступ к API необходимыми IP-адресами.
   - Настройте `fail2ban` для защиты от брутфорса.

5. **Обновления**
   - Регулярно обновляйте систему и зависимости.
   - Следите за обновлениями Vertex AR.

6. **Механизмы контроля**
   - Используйте встроенные лимиты запросов и блокировку после неудачных попыток.
   - Проверяйте логи входов и активности.

---

## Производительность

### Оптимизация

1. **База данных**
   - Периодически выполняйте `VACUUM`:
     ```bash
     sqlite3 vertex-ar/app_data.db "VACUUM;"
     ```
   - Планируйте миграцию к PostgreSQL при росте нагрузки.

2. **Хранилище**
   - Используйте SSD.
   - Разнесите горячие и холодные данные.
   - Настройте кэширование на уровне веб-сервера.

3. **Превью и медиа**
   - Превью генерируются один раз при загрузке, храните их на быстрых дисках.
   - При увеличении трафика рассмотрите использование CDN.

### Масштабирование

1. Вынесите статический контент и QR-коды на CDN.
2. Используйте балансировщик нагрузки для API.
3. Добавьте Redis или аналог для кэширования.
4. Автоматизируйте резервные копии и развертывание обновлений.

---

## Заключение

Это руководство охватывает основные аспекты администрирования Vertex AR. При возникновении вопросов обращайтесь к:

- API-документации: `/docs`
- Интерактивной документации: `/redoc`
- Руководству по управлению пользователями: [USER_MANAGEMENT.md](./USER_MANAGEMENT.md)
- Репозиторию проекта: [https://github.com/fegerV/ar](https://github.com/fegerV/ar)

Удачной работы с Vertex AR!
