# Видео Расписание (Video Animation Scheduler)

## Обзор

Система видео расписания Vertex AR позволяет автоматически управлять активностью видеоанимаций по заданному расписанию. Это обеспечивает своевременную активацию и деактивацию контента без необходимости ручного вмешательства.

## Основные возможности

### 1. Планирование по времени
- **Начало активности**: Укажите дату и время, когда видео должно стать активным
- **Окончание активности**: Укажите дату и время, когда видео должно быть деактивировано
- **Автоматическая архивация**: Видео автоматически архивируются после истечения срока активности

### 2. Ротация видео
- **Последовательная ротация**: Видео активируются в хронологическом порядке по времени начала
- **Циклическая ротация**: Видео циклически меняются по кругу
- **Без ротации**: Видео управляется только вручную

### 3. Управление статусами
- **Активный**: Видео видно в AR и доступно для просмотра
- **Неактивный**: Видео существует, но не отображается в AR
- **Архивный**: Видео скрыто из интерфейса и хранится для истории

## Техническая реализация

### База данных
- Добавлены колонки в таблицу `videos`:
  - `start_datetime`: Время начала активности
  - `end_datetime`: Время окончания активности
  - `rotation_type`: Тип ротации (none, sequential, cyclic)
  - `status`: Статус видео (active, inactive, archived)
- Новая таблица `video_schedule_history` для аудита изменений

### API эндпоинты
- `PUT /videos/{video_id}/schedule` - Обновить расписание видео
- `GET /videos/{video_id}/schedule/history` - Получить историю изменений
- `POST /videos/rotation/trigger` - Запустить ротацию вручную
- `GET /videos/scheduler/status` - Получить статус планировщика
- `POST /videos/scheduler/archive-expired` - Архивировать истекшие видео

### Фоновые задачи
- Автоматическая проверка расписания каждые 5 минут
- Ротация видео каждый час
- Автоматическая архивация через неделю после окончания

## Конфигурация

```bash
# Включить планировщик видео
VIDEO_SCHEDULER_ENABLED=true

# Интервал проверки в секундах (по умолчанию: 300 = 5 минут)
VIDEO_SCHEDULER_CHECK_INTERVAL=300

# Интервал проверки ротации в секундах (по умолчанию: 3600 = 1 час)
VIDEO_SCHEDULER_ROTATION_INTERVAL=3600

# Автоархивация через указанное количество часов (по умолчанию: 168 = 1 неделя)
VIDEO_SCHEDULER_ARCHIVE_AFTER_HOURS=168

# Включить уведомления планировщика
VIDEO_SCHEDULER_NOTIFICATIONS_ENABLED=true
```

## Админ-интерфейс

Новая панель управления доступна в админ-разделе `/admin/videos/schedule`:
- Статус планировщика и время последней проверки
- Список всех видео с настройками расписания
- Управление статусом видео
- История изменений
- Массовые операции

## Интеграция с уведомлениями

Система автоматически отправляет уведомления при:
- Автоматической активации видео
- Автоматической деактивации видео
- Ротации видео
- Массовом архивировании

## Мониторинг

### Метрики Prometheus
- Количество активных/неактивных/архивных видео
- Время последней проверки планировщика
- Количество обработанных событий

### Логи
Все действия планировщика логируются с уровнем INFO:
- Активация/деактивация видео
- Ошибки планировщика
- Статистика выполнения

## Примеры использования

### Рекламная кампания
```json
{
  "start_datetime": "2024-12-01T09:00:00Z",
  "end_datetime": "2024-12-31T23:59:59Z",
  "rotation_type": "sequential",
  "status": "active"
}
```

### Временная акция
```json
{
  "start_datetime": "2024-01-20T00:00:00Z",
  "end_datetime": "2024-01-27T23:59:59Z",
  "rotation_type": "none",
  "status": "active"
}
```

### Циклическая ротация
```json
{
  "start_datetime": "2024-01-01T10:00:00Z",
  "end_datetime": null,
  "rotation_type": "cyclic",
  "status": "active"
}
```

## Безопасность

- Только администраторы могут изменять расписание
- Все пользователи могут просматривать активные видео
- История изменений доступна только администраторам
- Валидация формата даты/времени и типов данных

## Будущие улучшения

1. **Расширенные правила ротации**: Условная активация по дням недели
2. **Графический таймлайн**: Визуальное представление расписания
3. **Массовые операции**: Одновременное изменение расписания группы видео
4. **Интеграция с календарями**: Экспорт/импорт расписания в Google Calendar
5. **Аналитика эффективности**: Статистика просмотра по периодам активности

---

**Подробнее:** [VIDEO_SCHEDULER_FEATURE.md](../../vertex-ar/VIDEO_SCHEDULER_FEATURE.md)