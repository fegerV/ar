# Справочник эндпоинтов Vertex AR (v1.3.0)

Ниже приведены основные REST-эндпоинты Vertex AR. Все пути указаны относительно базового URL (`http://localhost:8000`). Если не сказано иначе, ответы возвращаются в JSON.

Обозначения:
- **Auth:** уровень доступа (`anon` — без токена, `user` — авторизованный, `admin` — права администратора).
- **200/201/204** — успешные ответы.
- **422** — ошибка валидации.
- **401/403** — проблемы с авторизацией.
- **429** — превышен лимит запросов.

---

## 1. Аутентификация (`/auth`)

| Метод | Путь | Описание | Auth |
| --- | --- | --- | --- |
| `POST` | `/auth/register` | Регистрация нового пользователя (по умолчанию `admin`, можно отключить через `ALLOW_REGISTRATION`) | anon |
| `POST` | `/auth/login` | Получение JWT-токена | anon |
| `POST` | `/auth/logout` | Инвалидировать токен (логируется) | user |
| `POST` | `/auth/refresh` | Выпуск нового токена (если включено) | user |
| `POST` | `/auth/password/change` | Смена пароля текущего пользователя | user |

**Примечания:**
- Пароли проверяются на длину ≥8 символов, наличие букв и цифр.
- После 5 неудачных попыток аккаунт блокируется на `AUTH_LOCKOUT_MINUTES`.

---

## 2. Пользователи (`/api/users`)

| Метод | Путь | Описание | Auth |
| --- | --- | --- | --- |
| `GET` | `/api/users` | Список пользователей с пагинацией и фильтрами (`role`, `status`) | admin |
| `GET` | `/api/users/{username}` | Информация о пользователе | admin |
| `POST` | `/api/users` | Создание пользователя (роль, пароль, email) | admin |
| `PUT` | `/api/users/{username}` | Обновление профиля и ролей | admin |
| `DELETE` | `/api/users/{username}` | Soft delete пользователя | admin |
| `GET` | `/api/users/stats` | Сводка по активным/заблокированным пользователям | admin |

---

## 3. Клиенты (`/api/clients`)

| Метод | Путь | Описание | Auth |
| --- | --- | --- | --- |
| `POST` | `/api/clients` | Создать клиента (имя, телефон) | admin |
| `GET` | `/api/clients` | Список клиентов с фильтрацией по телефону/имени | admin |
| `GET` | `/api/clients/{client_id}` | Подробности клиента | admin |
| `PUT` | `/api/clients/{client_id}` | Обновление данных клиента | admin |
| `DELETE` | `/api/clients/{client_id}` | Удаление клиента | admin |
| `GET` | `/api/clients/search` | Быстрый поиск по телефону | admin |

Телефоны нормализуются (формат `+79991234567`), проверяется уникальность.

---

## 4. Портреты (`/api/portraits`)

| Метод | Путь | Описание | Auth |
| --- | --- | --- | --- |
| `POST` | `/api/portraits` | Загрузка портрета (image + meta) | admin |
| `GET` | `/api/portraits` | Список портретов (пагинация, фильтры по клиенту) | admin |
| `GET` | `/api/portraits/{portrait_id}` | Подробности портрета и связанные видео | admin |
| `DELETE` | `/api/portraits/{portrait_id}` | Удаление портрета и связанных ресурсов | admin |
| `GET` | `/portrait/{permanent_link}` | Публичный просмотр AR-портрета | anon |

При загрузке формируется постоянная ссылка, QR-код и NFT-маркер.

---

## 5. Видео (`/api/videos`)

| Метод | Путь | Описание | Auth |
| --- | --- | --- | --- |
| `POST` | `/api/videos` | Загрузка видео и привязка к портрету | admin |
| `POST` | `/api/videos/{video_id}/activate` | Сделать видео активным | admin |
| `DELETE` | `/api/videos/{video_id}` | Удалить видео | admin |
| `GET` | `/api/videos/{video_id}` | Информация о видео (активность, путь) | admin |

Допускаются форматы `mp4`, `webm`, `mov`. Размер проверяется модулем валидации.

---

## 6. NFT-маркеры (`/api/nft-markers`)

| Метод | Путь | Описание | Auth |
| --- | --- | --- | --- |
| `POST` | `/api/nft-markers/generate` | Генерация маркера из изображения | admin |
| `POST` | `/api/nft-markers/batch-generate` | Пакетная генерация (до 10 изображений) | admin |
| `GET` | `/api/nft-markers/preview` | Предпросмотр feature points (URL в ответе) | admin |
| `GET` | `/api/nft-markers/analytics` | Статистика по маркерам, hit-rate кэша | admin |
| `GET` | `/api/nft-markers/metrics` | Технические метрики (время генерации, DPI) | admin |
| `POST` | `/api/nft-markers/cleanup` | Очистка неиспользуемых маркеров | admin |
| `DELETE` | `/api/nft-markers/cache` | Сбросить кэш анализа | admin |

Все операции логируются с указанием пользователя и длительности.

---

## 7. AR-просмотр и QR (`/ar`, `/qr`)

| Метод | Путь | Описание | Auth |
| --- | --- | --- | --- |
| `GET` | `/ar/{content_id}` | HTML-страница для просмотра AR-сцены | anon |
| `GET` | `/qr/{content_id}` | QR-код для быстрого доступа | anon |
| `GET` | `/storage/{path}` | Доступ к файлам хранилища (через токен или публичную ссылку) | user |

HTML-страницы используют A-Frame и AR.js, поддерживают мобильные устройства.

---

## 8. Системные эндпоинты

| Метод | Путь | Описание | Auth |
| --- | --- | --- | --- |
| `GET` | `/` | Стартовая страница | anon |
| `GET` | `/health` | Проверка здоровья сервиса | anon |
| `GET` | `/metrics` | Технические метрики (если включено) | admin |
| `GET` | `/docs`, `/redoc` | OpenAPI и ReDoc | anon |

---

## 9. Ответы об ошибках

Пример структуры ошибки:
```json
{
  "detail": "Неверный формат телефона",
  "code": "validation_error",
  "fields": {
    "phone": ["Должен содержать 11 цифр"]
  },
  "request_id": "02c9a534-e0f0-4c52-9d41-4fdc4f1d4c7a"
}
```

Все ошибки сопровождаются request ID, что облегчает поиск записи в логах.

---

## 10. Советы по интеграции

- Используйте отдельные сервисные аккаунты для автоматизации.
- Следите за кодами `429` и реализуйте повтор запросов с экспоненциальной задержкой.
- Проверяйте заголовок `X-Request-ID` для трассировки.
- Для длительных операций (batch) проверяйте информационные поля в ответах (`progress`, `estimated_time`).

Пользуйтесь [примерами](examples.md) для быстрых интеграций на cURL и Python.
