# Архитектура Vertex AR

**Версия:** 1.3.0
**Дата обновления:** 7 ноября 2024

Документ описывает архитектурные решения системы Vertex AR, ключевые компоненты и потоки данных.

---

## 1. Обзор

Vertex AR — веб-приложение на FastAPI, которое позволяет загружать портреты, привязывать к ним мультимедиа и воспроизводить сцены дополненной реальности. Система состоит из следующих слоёв:

1. **Веб-интерфейс:** админ-панель и AR-viewer (A-Frame + AR.js).
2. **Backend:** REST API, бизнес-логика, генератор NFT-маркеров.
3. **Хранилище:** локальная файловая система или MinIO/S3.
4. **База данных:** SQLite (планируется переход на PostgreSQL).
5. **Служебные компоненты:** валидация, логирование, мониторинг, автоматические скрипты.

---

## 2. Стек технологий

- **Backend:** FastAPI, Python 3.10, SQLAlchemy, Pydantic v2
- **AR и фронтенд:** A-Frame, AR.js, Anime.js, Jinja2
- **Хранилище:** локальный диск / MinIO / S3 (через единый адаптер)
- **Инфраструктура:** Docker, Docker Compose, Nginx, Supervisor
- **Логирование:** structlog, JSON-формат, request ID

---

## 3. Компоненты

### 3.1 Слои приложения

```
┌────────────────────────────────────────────────────┐
│                 Веб-клиенты и устройства           │
│  ├─ Админ-панель (Jinja2 + Alpine.js)              │
│  ├─ AR Viewer (A-Frame + AR.js)                    │
│  └─ Интеграции (curl/SDK)                          │
└───────────────────┬────────────────────────────────┘
                    │ HTTP(S)
┌───────────────────┴────────────────────────────────┐
│                    FastAPI backend                 │
│  ├─ app/api/auth.py                                │
│  ├─ app/api/clients.py                             │
│  ├─ app/api/portraits.py                           │
│  ├─ app/api/videos.py                              │
│  ├─ app/api/nft_markers.py                         │
│  └─ app/api/users.py                               │
│        │                    │                     │
│  ┌─────▼─────┐      ┌───────▼─────────┐     ┌─────▼─────┐
│  Validators  │      │ Storage adapter │     │  Services │
│  (Pydantic)  │      │ (local / MinIO) │     │  (QR, NFT)│
└──────┬───────┘      └────────┬────────┘     └─────┬─────┘
       │                       │                     │
┌──────▼──────┐        ┌───────▼──────┐     ┌────────▼────────┐
│ SQLite /    │        │ File system  │     │ Асинхронные      │
│ PostgreSQL* │        │ или MinIO    │     │ задачи (план)    │
└─────────────┘        └──────────────┘     └─────────────────┘
```

"+" *Подготовка к миграции на PostgreSQL ведётся в релизе 1.4.*

### 3.2 Основные модули

| Модуль | Назначение |
| --- | --- |
| `app/main.py` | Инициализация FastAPI, middleware, маршрутизация |
| `app/api/*` | REST-эндпоинты (auth, users, clients, portraits, videos, nft_markers) |
| `app/models.py` | Pydantic-схемы и валидаторы (email, телефон, пароль, имя, UUID, файлы) |
| `app/validators.py` | Централизованная валидация и нормализация данных |
| `app/middleware.py` | Request/Response logging, error logging, validation logging |
| `app/storage.py` | Адаптеры хранилища (локально, MinIO/S3), управление файлами |
| `nft_marker_generator.py` | Генерация NFT-маркеров, batch-пайплайн, аналитика |
| `templates/` | Админ-панель, viewer, email-шаблоны |

---

## 4. Потоки данных

### 4.1 Загрузка портрета

1. Администратор загружает файл через `/api/portraits` или админ-панель.
2. Файл проходит валидацию (размер, MIME, разрешение).
3. Данные сохраняются в БД, изображение — в хранилище (`storage/ar_content`).
4. Генерируется NFT-маркер (файлы `.fset`, `.fset3`, `.iset`).
5. Создаётся QR-код и постоянная ссылка `/portrait/{uuid}`.

### 4.2 Просмотр сцены

1. Пользователь открывает ссылку или сканирует QR.
2. AR-viewer загружает маркеры и видео.
3. A-Frame и AR.js отображают сцену через камеру устройства.
4. Статистика просмотров фиксируется и логируется.

---

## 5. Хранилище и файлы

- **Локальный режим:** директория `storage/` внутри проекта.
- **MinIO/S3:** используется при установке `STORAGE_TYPE=minio`.
- **Валидация:** проверка magic bytes, MIME, размеров, поддерживаемых расширений.
- **Очистка:** `api/nft-markers/cleanup` удаляет неактивные маркеры, скрипты обслуживания чистят временные файлы.

Структура хранения:
```
storage/
├── ar_content/
│   ├── images/
│   └── videos/
├── nft-markers/
├── qr-codes/
└── previews/
```

---

## 6. Безопасность

- JWT-токены с настройкой TTL и блокировками
- Rate limiting (`slowapi`) на уровне глобальных и авторизационных эндпоинтов
- Централизованная валидация данных (`validators.py`)
- Логирование ошибок 4xx/5xx, валидаций, request ID и IP-адресов
- Конфигурация CORS через `.env`
- Подготовка к 2FA/OAuth2 в релизе 1.5

---

## 7. Логирование и наблюдаемость

- `RequestLoggingMiddleware` — метод, путь, статус, длительность, request ID
- `ErrorLoggingMiddleware` — ошибки 4xx/5xx со стек-трейсами
- `ValidationLoggingMiddleware` — информация о 422-ответах и полях
- Логи в JSON-формате, совместимы с ELK / Loki / Datadog
- Скрипты `run_performance_tests.sh` и `check_production_readiness.sh`

---

## 8. Развёртывание

- **Docker Compose:** основной способ локального и продакшен-развертывания
- **Nginx:** обратный прокси, HTTPS, сжатие, кэширование статических файлов
- **Supervisor/Systemd:** управление процессами в продакшене (опционально)
- **CI/CD (план):** линтеры, pytest, pytest-cov, публикация отчётов (релиз 1.4)

---

## 9. Масштабирование и планы (v1.4–v1.5)

- Перевод БД на PostgreSQL, миграции Alembic
- Очередь фоновых задач (RQ/Celery) для генерации маркеров
- Поддержка CDN и кэширования
- Расширенные дашборды и алерты (Prometheus/Grafana)
- Мобильные приложения и 3D-контент (в перспективе v2.0)

---

## 10. Ссылки

- Основной README: `../../README.md`
- Руководство по установке: `../guides/installation.md`
- API: `../api/README.md`, `../api/endpoints.md`
- Политика безопасности: `../../SECURITY.md`
- Roadmap: `../../ROADMAP.md`

Документ актуален для релиза 1.3.0. Предложения по улучшению архитектуры обсуждаются в GitHub Discussions.
